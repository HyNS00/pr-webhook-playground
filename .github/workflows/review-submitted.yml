name: review-submitted.yml
on:
  pull_request_review:
    types: [ submitted ]
jobs:
  log:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "=== REVIEW SUBMITTED (pull_request_review.submitted) ==="
          echo "Workflow triggered at: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "--- PR Info ---"
          echo "PR Number: #${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo ""
          echo "--- Review Info ---"
          echo "Review ID: ${{ github.event.review.id }}"
          echo "Reviewer: ${{ github.event.review.user.login }}"
          echo "State: ${{ github.event.review.state }}"
          echo "Submitted At: ${{ github.event.review.submitted_at }}"
          echo ""
          echo "--- Review Body ---"
          echo "${{ github.event.review.body }}"
          echo ""
          echo "--- Review HTML URL ---"
          echo "${{ github.event.review.html_url }}"

      - name: Fetch Review Comments via API
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== FETCHING REVIEW COMMENTS ==="
          echo "API: /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews/${{ github.event.review.id }}/comments"
          echo ""

          COMMENTS=$(gh api \
            /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews/${{ github.event.review.id }}/comments)

          echo "--- Raw JSON ---"
          echo "$COMMENTS" | jq '.'

          echo ""
          echo "--- Comments Summary ---"
          COMMENT_COUNT=$(echo "$COMMENTS" | jq 'length')
          echo "Total Comments in this Review: $COMMENT_COUNT"
          echo ""

          echo "$COMMENTS" | jq -r '.[] | "[\(.id)] \(.user.login) @ \(.path):\(.line)\n\(.body)\n---"'
